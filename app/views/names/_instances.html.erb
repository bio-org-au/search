<% if name.present? %>
  <div class="name-details">
  <% shown = [] -%>
  <% apc_instance_id = name.apc_instance_id -%>
  <% name_details.each do | name_detail | %>
    <div class="instance-citation from-partial">
    <% unless shown.include?(name_detail.instance_id) %>
      <div class="standalone-instance-citation">
      <%= name_detail.entry.sub(/: \z/,'').html_safe %>

      <% if name_detail.instance.has_protologue? %>
        <%= render partial: "application/protologue_link", locals: {instance: name_detail.instance} %>
      <% end %>

      <% if name_detail.instance_id == name.apc_instance_id %>
        <span class="accepted-or-excluded-indicator red">
          <% case name_detail.instance.accepted_name.type_code %>
          <% when 'ApcConcept' %>
            <span title="<%= %Q(#{ classification_tree_key } Concept) %>" ><%= fa_icon('check', class: 'fa-lg green') %><%= classification_tree_key %></span>
          <% when 'ApcExcluded' %>
            <span title="Excluded from #{ classification_tree_key }"><%= fa_icon('ban', class: 'fa-lg red') %><%= classification_tree_key %></span>
          <% end %>
        </span>
      <% end %>

      <% if name_detail.instance.bhl_url.present? %>
        <%= link_to("BHL #{fa_icon('external-link')}".html_safe,
                    name_detail.instance.bhl_url,
                    class: "bhl-link external-link opens-in-new-tab-or-window",
                    target: "_blank",
                    title: "Link to Biodiversity Heritage Library source page. (Opens in a new tab or window)") %>
      <% end =%>
      </div>

        <% name_detail.instance_notes_for_details.only_type_notes.sort {|x,y| x.instance_note_key.sort_order <=> y.instance_note_key.sort_order }.each do |note| %>
          <div class="instance-note">
            <span class="instance-note-label"><%= note.instance_note_key.name %>:</span>
            <span class="instance-note-value">
              <%= note.marked_up_value.html_safe %>
            </span>
          </div>
        <% end %>
        <%#= render partial: "names/instance_synonyms", locals: {name: name, name_detail: name_detail} %>

      <% end %>
    </div>
    <% shown.push name_detail.instance_id %>
  <% end %>
  <% show_power_links = true if show_power_links.nil? %>
  <% if show_power_links %>
    <% if name.direct_sub_taxa_with_instance_count > 0 %>
      <%= render(partial: '/names/search/power_links', locals: {name: name}) %>
    <% end %>
  <% end %>

  <% if name.images_supported? && name.rank.species_or_below? && name.images_present? %>
    <br/>
    <%=
      link_to(fa_icon("camera", class: "fa-lg black") + "&nbsp;x&nbsp;#{name.image_count}".html_safe,
              "#{Rails.configuration.image_display_url}#{name.simple_name}",
              target: "new",
              title: "Show images. Opens in a new tab or window.")
    %>

  <% end %>
  </div>
<% end %>
<span class="debug">names/_instances.html.erb</span>

